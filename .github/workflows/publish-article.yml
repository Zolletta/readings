name: 'Publish a new article'
run-name: ${{ github.actor }} is publishing an article
on:
  workflow_dispatch:
    inputs:
      article_name:
        description: "Article to publish"
        required: true
        default: "programmers-brain.md"
      publish_medium:
        description: "Publish to Medium?"
        required: true
        default: "true"

jobs:

  publish-a-new-article:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Pandoc
        uses: nikeee/setup-pandoc@v1
        with:
          pandoc-version: '2.9'

      - if: github.event.inputs.publish_medium == 'true'
        name: Publish to Medium
        run: |
          echo "## Published to Medium: âœ“" >> $GITHUB_STEP_SUMMARY
          
          ARTICLE_TITLE=`head -1 ${{ github.event.inputs.article_name }}| pandoc -t plain` 
          ARTICLE_CONTENTS=`cat ${{ github.event.inputs.article_name }} automated.md | pandoc -t plain`  
          
          JSON=$( jq -n \
                  --arg title "ARTICLE_TITLE" \
                  --arg content "ARTICLE_CONTENTS" \
                  --arg canonical "https://github.com/Zolletta/readings/blob/main/${{ github.event.inputs.article_name }}" \
                  --arg publish "public" \
                  --arg notify false \
                  '{title: $title, content: $content, canonicalUrl: $canonical, publishStatus: $publish, notifyFollowers: $notify}' )
          
          echo "#### Title: $ARTICLE_TITLE" >> $GITHUB_STEP_SUMMARY
          echo $JSON >> $GITHUB_STEP_SUMMARY

          POST_URL="https://api.medium.com/v1/users/$MEDIUM_USER_ID/posts"
          curl -d "$JSON" -H "Content-Type: application/json" -H "Authorization: Bearer $MEDIUM_SECRET" -X POST $POST_URL 

        env:
          MEDIUM_USER_ID: ${{ secrets.MEDIUM_USER_ID }}
          MEDIUM_SECRET: ${{ secrets.MEDIUM_SECRET }}
